
scloud@stg-master02:~/devops-mcc/1.stg/2.moss-db/1.postgres-service$ ka -f 1.sts.yaml 
warning: error calculating patch from openapi v3 spec: map: map[name:postgre volumeMounts:[map[mountPath:/dev/shm name:dshm]]] does not contain declared merge key: mountPath
warning: error calculating patch from openapi spec: map: map[name:postgre volumeMounts:[map[mountPath:/dev/shm name:dshm]]] does not contain declared merge key: mountPath
error: error when applying patch:

to:
Resource: "apps/v1, Resource=statefulsets", GroupVersionKind: "apps/v1, Kind=StatefulSet"
Name: "postgres", Namespace: "mcc"
for: "1.sts.yaml": error when patching "1.sts.yaml": creating patch with:
original:
{"apiVersion":"apps/v1","kind":"StatefulSet","metadata":{"annotations":{},"name":"postgres","namespace":"mcc"},"spec":{"replicas":2,"selector":{"matchLabels":{"app":"postgres"}},"serviceName":"postgres-headless","template":{"metadata":{"labels":{"app":"postgres"}},"spec":{"containers":[{"env":[{"name":"MY_POD_NAME","valueFrom":{"fieldRef":{"fieldPath":"metadata.name"}}},{"name":"REPMGR_NODE_NAME","value":"$(MY_POD_NAME)"},{"name":"REPMGR_NODE_NETWORK_NAME","value":"$(MY_POD_NAME).postgres-headless.mcc.svc.cluster.local"}],"envFrom":[{"configMapRef":{"name":"postgres"}},{"secretRef":{"name":"postgres"}}],"image":"docker.io/library/mcc-postgresql-repmgr:16.3.0","imagePullPolicy":"IfNotPresent","livenessProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":6,"periodSeconds":10,"timeoutSeconds":5},"name":"postgresql","readinessProbe":{"exec":{"command":["bash","-ec","exec pg_isready -U $POSTGRESQL_USERNAME -h 127.0.0.1 -p 5432\n[ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]\n"]},"failureThreshold":3,"initialDelaySeconds":10,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"startupProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":60,"initialDelaySeconds":100,"periodSeconds":100,"timeoutSeconds":10},"volumeMounts":[{"mountPath":"/bitnami/postgresql","name":"postgres-data"},{"mountPath":"/etc/localtime","name":"time-zone"},{"mountPath":"/opt/bitnami/restore-data","name":"restore-data"}]}],"nodeSelector":{"role":"db"},"volumes":[{"hostPath":{"path":"/usr/share/zoneinfo/Asia/Ho_Chi_Minh"},"name":"time-zone"}]}},"updateStrategy":{"type":"OnDelete"},"volumeClaimTemplates":[{"metadata":{"name":"postgres-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"100Gi"}},"storageClassName":"local-path"}},{"metadata":{"name":"restore-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"10Gi"}},"storageClassName":"local-path"}}]}}

modified:
{"apiVersion":"apps/v1","kind":"StatefulSet","metadata":{"annotations":{"kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"apps/v1\",\"kind\":\"StatefulSet\",\"metadata\":{\"annotations\":{},\"name\":\"postgres\",\"namespace\":\"mcc\"},\"spec\":{\"replicas\":2,\"selector\":{\"matchLabels\":{\"app\":\"postgres\"}},\"serviceName\":\"postgres-headless\",\"template\":{\"metadata\":{\"labels\":{\"app\":\"postgres\"}},\"spec\":{\"containers\":[{\"env\":[{\"name\":\"MY_POD_NAME\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.name\"}}},{\"name\":\"REPMGR_NODE_NAME\",\"value\":\"$(MY_POD_NAME)\"},{\"name\":\"REPMGR_NODE_NETWORK_NAME\",\"value\":\"$(MY_POD_NAME).postgres-headless.mcc.svc.cluster.local\"}],\"envFrom\":[{\"configMapRef\":{\"name\":\"postgres\"}},{\"secretRef\":{\"name\":\"postgres\"}}],\"image\":\"docker.io/library/mcc-postgresql-repmgr:16.3.0\",\"imagePullPolicy\":\"IfNotPresent\",\"livenessProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \\\"SELECT 1\\\"\"]},\"failureThreshold\":6,\"periodSeconds\":10,\"timeoutSeconds\":5},\"name\":\"postgresql\",\"readinessProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"exec pg_isready -U $POSTGRESQL_USERNAME -h 127.0.0.1 -p 5432\\n[ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]\\n\"]},\"failureThreshold\":3,\"initialDelaySeconds\":10,\"periodSeconds\":10,\"successThreshold\":1,\"timeoutSeconds\":5},\"startupProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \\\"SELECT 1\\\"\"]},\"failureThreshold\":60,\"initialDelaySeconds\":10,\"periodSeconds\":30,\"timeoutSeconds\":5},\"volumeMounts\":[{\"mountPath\":\"/bitnami/postgresql\",\"name\":\"postgres-data\"},{\"mountPath\":\"/etc/localtime\",\"name\":\"time-zone\"},{\"name\":\"postgre\",\"volumeMounts\":[{\"mountPath\":\"/dev/shm\",\"name\":\"dshm\"}]}]}],\"nodeSelector\":{\"role\":\"db\"},\"volumes\":[{\"hostPath\":{\"path\":\"/usr/share/zoneinfo/Asia/Ho_Chi_Minh\"},\"name\":\"time-zone\"},{\"emptyDir\":{\"medium\":\"Memory\",\"sizelimit\":\"1Gi\"},\"name\":\"dshm\"}]}},\"updateStrategy\":{\"type\":\"OnDelete\"},\"volumeClaimTemplates\":[{\"metadata\":{\"name\":\"postgres-data\"},\"spec\":{\"accessModes\":[\"ReadWriteOnce\"],\"resources\":{\"requests\":{\"storage\":\"100Gi\"}},\"storageClassName\":\"local-path\"}}]}}\n"},"name":"postgres","namespace":"mcc"},"spec":{"replicas":2,"selector":{"matchLabels":{"app":"postgres"}},"serviceName":"postgres-headless","template":{"metadata":{"labels":{"app":"postgres"}},"spec":{"containers":[{"env":[{"name":"MY_POD_NAME","valueFrom":{"fieldRef":{"fieldPath":"metadata.name"}}},{"name":"REPMGR_NODE_NAME","value":"$(MY_POD_NAME)"},{"name":"REPMGR_NODE_NETWORK_NAME","value":"$(MY_POD_NAME).postgres-headless.mcc.svc.cluster.local"}],"envFrom":[{"configMapRef":{"name":"postgres"}},{"secretRef":{"name":"postgres"}}],"image":"docker.io/library/mcc-postgresql-repmgr:16.3.0","imagePullPolicy":"IfNotPresent","livenessProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":6,"periodSeconds":10,"timeoutSeconds":5},"name":"postgresql","readinessProbe":{"exec":{"command":["bash","-ec","exec pg_isready -U $POSTGRESQL_USERNAME -h 127.0.0.1 -p 5432\n[ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]\n"]},"failureThreshold":3,"initialDelaySeconds":10,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"startupProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":60,"initialDelaySeconds":10,"periodSeconds":30,"timeoutSeconds":5},"volumeMounts":[{"mountPath":"/bitnami/postgresql","name":"postgres-data"},{"mountPath":"/etc/localtime","name":"time-zone"},{"name":"postgre","volumeMounts":[{"mountPath":"/dev/shm","name":"dshm"}]}]}],"nodeSelector":{"role":"db"},"volumes":[{"hostPath":{"path":"/usr/share/zoneinfo/Asia/Ho_Chi_Minh"},"name":"time-zone"},{"emptyDir":{"medium":"Memory","sizelimit":"1Gi"},"name":"dshm"}]}},"updateStrategy":{"type":"OnDelete"},"volumeClaimTemplates":[{"metadata":{"name":"postgres-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"100Gi"}},"storageClassName":"local-path"}}]}}

current:
{"apiVersion":"apps/v1","kind":"StatefulSet","metadata":{"annotations":{"kubectl.kubernetes.io/last-applied-configuration":"{\"apiVersion\":\"apps/v1\",\"kind\":\"StatefulSet\",\"metadata\":{\"annotations\":{},\"name\":\"postgres\",\"namespace\":\"mcc\"},\"spec\":{\"replicas\":2,\"selector\":{\"matchLabels\":{\"app\":\"postgres\"}},\"serviceName\":\"postgres-headless\",\"template\":{\"metadata\":{\"labels\":{\"app\":\"postgres\"}},\"spec\":{\"containers\":[{\"env\":[{\"name\":\"MY_POD_NAME\",\"valueFrom\":{\"fieldRef\":{\"fieldPath\":\"metadata.name\"}}},{\"name\":\"REPMGR_NODE_NAME\",\"value\":\"$(MY_POD_NAME)\"},{\"name\":\"REPMGR_NODE_NETWORK_NAME\",\"value\":\"$(MY_POD_NAME).postgres-headless.mcc.svc.cluster.local\"}],\"envFrom\":[{\"configMapRef\":{\"name\":\"postgres\"}},{\"secretRef\":{\"name\":\"postgres\"}}],\"image\":\"docker.io/library/mcc-postgresql-repmgr:16.3.0\",\"imagePullPolicy\":\"IfNotPresent\",\"livenessProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \\\"SELECT 1\\\"\"]},\"failureThreshold\":6,\"periodSeconds\":10,\"timeoutSeconds\":5},\"name\":\"postgresql\",\"readinessProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"exec pg_isready -U $POSTGRESQL_USERNAME -h 127.0.0.1 -p 5432\\n[ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]\\n\"]},\"failureThreshold\":3,\"initialDelaySeconds\":10,\"periodSeconds\":10,\"successThreshold\":1,\"timeoutSeconds\":5},\"startupProbe\":{\"exec\":{\"command\":[\"bash\",\"-ec\",\"PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \\\"SELECT 1\\\"\"]},\"failureThreshold\":60,\"initialDelaySeconds\":100,\"periodSeconds\":100,\"timeoutSeconds\":10},\"volumeMounts\":[{\"mountPath\":\"/bitnami/postgresql\",\"name\":\"postgres-data\"},{\"mountPath\":\"/etc/localtime\",\"name\":\"time-zone\"},{\"mountPath\":\"/opt/bitnami/restore-data\",\"name\":\"restore-data\"}]}],\"nodeSelector\":{\"role\":\"db\"},\"volumes\":[{\"hostPath\":{\"path\":\"/usr/share/zoneinfo/Asia/Ho_Chi_Minh\"},\"name\":\"time-zone\"}]}},\"updateStrategy\":{\"type\":\"OnDelete\"},\"volumeClaimTemplates\":[{\"metadata\":{\"name\":\"postgres-data\"},\"spec\":{\"accessModes\":[\"ReadWriteOnce\"],\"resources\":{\"requests\":{\"storage\":\"100Gi\"}},\"storageClassName\":\"local-path\"}},{\"metadata\":{\"name\":\"restore-data\"},\"spec\":{\"accessModes\":[\"ReadWriteOnce\"],\"resources\":{\"requests\":{\"storage\":\"10Gi\"}},\"storageClassName\":\"local-path\"}}]}}\n"},"creationTimestamp":"2025-10-05T08:21:46Z","generation":3,"managedFields":[{"apiVersion":"apps/v1","fieldsType":"FieldsV1","fieldsV1":{"f:metadata":{"f:annotations":{".":{},"f:kubectl.kubernetes.io/last-applied-configuration":{}}},"f:spec":{"f:persistentVolumeClaimRetentionPolicy":{".":{},"f:whenDeleted":{},"f:whenScaled":{}},"f:podManagementPolicy":{},"f:replicas":{},"f:revisionHistoryLimit":{},"f:selector":{},"f:serviceName":{},"f:template":{"f:metadata":{"f:labels":{".":{},"f:app":{}}},"f:spec":{"f:containers":{"k:{\"name\":\"postgresql\"}":{".":{},"f:env":{".":{},"k:{\"name\":\"MY_POD_NAME\"}":{".":{},"f:name":{},"f:valueFrom":{".":{},"f:fieldRef":{}}},"k:{\"name\":\"REPMGR_NODE_NAME\"}":{".":{},"f:name":{},"f:value":{}},"k:{\"name\":\"REPMGR_NODE_NETWORK_NAME\"}":{".":{},"f:name":{},"f:value":{}}},"f:envFrom":{},"f:image":{},"f:imagePullPolicy":{},"f:livenessProbe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failureThreshold":{},"f:periodSeconds":{},"f:successThreshold":{},"f:timeoutSeconds":{}},"f:name":{},"f:readinessProbe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:timeoutSeconds":{}},"f:resources":{},"f:startupProbe":{".":{},"f:exec":{".":{},"f:command":{}},"f:failureThreshold":{},"f:initialDelaySeconds":{},"f:periodSeconds":{},"f:successThreshold":{},"f:timeoutSeconds":{}},"f:terminationMessagePath":{},"f:terminationMessagePolicy":{},"f:volumeMounts":{".":{},"k:{\"mountPath\":\"/bitnami/postgresql\"}":{".":{},"f:mountPath":{},"f:name":{}},"k:{\"mountPath\":\"/etc/localtime\"}":{".":{},"f:mountPath":{},"f:name":{}},"k:{\"mountPath\":\"/opt/bitnami/restore-data\"}":{".":{},"f:mountPath":{},"f:name":{}}}}},"f:dnsPolicy":{},"f:nodeSelector":{},"f:restartPolicy":{},"f:schedulerName":{},"f:securityContext":{},"f:terminationGracePeriodSeconds":{},"f:volumes":{".":{},"k:{\"name\":\"time-zone\"}":{".":{},"f:hostPath":{".":{},"f:path":{},"f:type":{}},"f:name":{}}}}},"f:updateStrategy":{"f:type":{}},"f:volumeClaimTemplates":{}}},"manager":"kubectl-client-side-apply","operation":"Update","time":"2025-10-08T08:07:00Z"},{"apiVersion":"apps/v1","fieldsType":"FieldsV1","fieldsV1":{"f:status":{"f:availableReplicas":{},"f:collisionCount":{},"f:currentRevision":{},"f:observedGeneration":{},"f:readyReplicas":{},"f:replicas":{},"f:updateRevision":{},"f:updatedReplicas":{}}},"manager":"kube-controller-manager","operation":"Update","subresource":"status","time":"2025-11-27T07:22:59Z"}],"name":"postgres","namespace":"mcc","resourceVersion":"12427628","uid":"8c1ed5a1-cce8-4f00-9d28-40ff8314375f"},"spec":{"persistentVolumeClaimRetentionPolicy":{"whenDeleted":"Retain","whenScaled":"Retain"},"podManagementPolicy":"OrderedReady","replicas":2,"revisionHistoryLimit":10,"selector":{"matchLabels":{"app":"postgres"}},"serviceName":"postgres-headless","template":{"metadata":{"creationTimestamp":null,"labels":{"app":"postgres"}},"spec":{"containers":[{"env":[{"name":"MY_POD_NAME","valueFrom":{"fieldRef":{"apiVersion":"v1","fieldPath":"metadata.name"}}},{"name":"REPMGR_NODE_NAME","value":"$(MY_POD_NAME)"},{"name":"REPMGR_NODE_NETWORK_NAME","value":"$(MY_POD_NAME).postgres-headless.mcc.svc.cluster.local"}],"envFrom":[{"configMapRef":{"name":"postgres"}},{"secretRef":{"name":"postgres"}}],"image":"docker.io/library/mcc-postgresql-repmgr:16.3.0","imagePullPolicy":"IfNotPresent","livenessProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":6,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"name":"postgresql","readinessProbe":{"exec":{"command":["bash","-ec","exec pg_isready -U $POSTGRESQL_USERNAME -h 127.0.0.1 -p 5432\n[ -f /opt/bitnami/postgresql/tmp/.initialized ] || [ -f /bitnami/postgresql/.initialized ]\n"]},"failureThreshold":3,"initialDelaySeconds":10,"periodSeconds":10,"successThreshold":1,"timeoutSeconds":5},"resources":{},"startupProbe":{"exec":{"command":["bash","-ec","PGPASSWORD=$POSTGRESQL_PASSWORD psql -w -U $POSTGRESQL_USERNAME -d $POSTGRESQL_DATABASE -h 127.0.0.1 -p 5432 -c \"SELECT 1\""]},"failureThreshold":60,"initialDelaySeconds":100,"periodSeconds":100,"successThreshold":1,"timeoutSeconds":10},"terminationMessagePath":"/dev/termination-log","terminationMessagePolicy":"File","volumeMounts":[{"mountPath":"/bitnami/postgresql","name":"postgres-data"},{"mountPath":"/etc/localtime","name":"time-zone"},{"mountPath":"/opt/bitnami/restore-data","name":"restore-data"}]}],"dnsPolicy":"ClusterFirst","nodeSelector":{"role":"db"},"restartPolicy":"Always","schedulerName":"default-scheduler","securityContext":{},"terminationGracePeriodSeconds":30,"volumes":[{"hostPath":{"path":"/usr/share/zoneinfo/Asia/Ho_Chi_Minh","type":""},"name":"time-zone"}]}},"updateStrategy":{"type":"OnDelete"},"volumeClaimTemplates":[{"apiVersion":"v1","kind":"PersistentVolumeClaim","metadata":{"creationTimestamp":null,"name":"postgres-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"100Gi"}},"storageClassName":"local-path","volumeMode":"Filesystem"},"status":{"phase":"Pending"}},{"apiVersion":"v1","kind":"PersistentVolumeClaim","metadata":{"creationTimestamp":null,"name":"restore-data"},"spec":{"accessModes":["ReadWriteOnce"],"resources":{"requests":{"storage":"10Gi"}},"storageClassName":"local-path","volumeMode":"Filesystem"},"status":{"phase":"Pending"}}]},"status":{"availableReplicas":2,"collisionCount":0,"currentRevision":"postgres-5588466d9","observedGeneration":3,"readyReplicas":2,"replicas":2,"updateRevision":"postgres-7d9dbc665c","updatedReplicas":2}}

for:: map: map[name:postgre volumeMounts:[map[mountPath:/dev/shm name:dshm]]] does not contain declared merge key: mountPath
