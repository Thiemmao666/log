HÆ°á»›ng dáº«n nÃ y táº­p trung vÃ o phÆ°Æ¡ng phÃ¡p chuáº©n vÃ  phá»• biáº¿n nháº¥t: cÃ i Ä‘áº·t cá»¥m Kubernetes (kubeadm) HA vá»›i kube-vip cháº¡y dÆ°á»›i dáº¡ng Static Pod. CÃ¡ch nÃ y giáº£i quyáº¿t bÃ i toÃ¡n "con gÃ  - quáº£ trá»©ng" khi VIP chÆ°a tá»“n táº¡i mÃ  kubeadm init Ä‘Ã£ cáº§n dÃ¹ng VIP lÃ m endpoint .

DÆ°á»›i Ä‘Ã¢y lÃ  quy trÃ¬nh tá»«ng bÆ°á»›c chi tiáº¿t.

1. Chuáº©n bá»‹ (TrÃªn Node Control Plane Ä‘áº§u tiÃªn)

TrÆ°á»›c khi cháº¡y kubeadm init, báº¡n cáº§n táº¡o file manifest Ä‘á»ƒ kubelet cháº¡y kube-vip trÆ°á»›c.

BÆ°á»›c 1: Äáº·t biáº¿n mÃ´i trÆ°á»ng

```bash
# Äá»‹a chá»‰ VIP báº¡n muá»‘n dÃ¹ng cho API Server
export VIP=192.168.0.40

# TÃªn interface máº¡ng tháº­t (dÃ¹ng lá»‡nh 'ip a' Ä‘á»ƒ xem, vÃ­ dá»¥: ens160, eth0)
export INTERFACE=ens160

# Láº¥y phiÃªn báº£n kube-vip má»›i nháº¥t
export KVVERSION=$(curl -sL https://api.github.com/repos/kube-vip/kube-vip/releases | jq -r ".[0].name")
```

YÃªu cáº§u: jq vÃ  curl Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t. Báº¡n cÅ©ng cÃ³ thá»ƒ set cá»©ng KVVERSION=v0.8.0 .

BÆ°á»›c 2: Táº¡o alias cho container runtime

Â· Náº¿u dÃ¹ng Docker:
  alias kube-vip="docker run --network host --rm ghcr.io/kube-vip/kube-vip:$KVVERSION"
Â· Náº¿u dÃ¹ng Containerd (thÆ°á»ng dÃ¹ng vá»›i kubeadm):
  alias kube-vip="ctr image pull ghcr.io/kube-vip/kube-vip:$KVVERSION; ctr run --rm --net-host ghcr.io/kube-vip/kube-vip:$KVVERSION vip /kube-vip"

2. Sinh Manifest cho Static Pod

Táº¡o file cáº¥u hÃ¬nh vÃ  Ä‘áº·t trá»±c tiáº¿p vÃ o thÆ° má»¥c manifest cá»§a kubelet. ThÆ° má»¥c /etc/kubernetes/manifests/ pháº£i Ä‘Æ°á»£c táº¡o trÆ°á»›c.

ğŸ”¹ Cháº¿ Ä‘á»™ ARP (Layer 2) - Phá»• biáº¿n cho On-Prem

```bash
kube-vip manifest pod \
    --interface $INTERFACE \
    --address $VIP \
    --controlplane \
    --services \
    --arp \
    --leaderElection | tee /etc/kubernetes/manifests/kube-vip.yaml
```

Giáº£i thÃ­ch: --controlplane báº­t HA cho control plane, --services báº­t tÃ­nh nÄƒng LoadBalancer cho Service (tÃ¹y chá»n) .

ğŸ”¸ Cháº¿ Ä‘á»™ BGP (Layer 3)
Náº¿u báº¡n cÃ³ router há»— trá»£ BGP:

```bash
export INTERFACE=lo  # NÃªn dÃ¹ng loopback cho BGP
kube-vip manifest pod \
    --interface $INTERFACE \
    --address $VIP \
    --controlplane \
    --services \
    --bgp \
    --localAS 65000 \
    --bgpRouterID 192.168.0.2 \
    --bgppeers 192.168.0.10:65000::false,192.168.0.11:65000::false | tee /etc/kubernetes/manifests/kube-vip.yaml
```



3. Khá»Ÿi táº¡o Cluster vá»›i VIP

Sau khi file kube-vip.yaml Ä‘Ã£ náº±m trong thÆ° má»¥c manifest, kubelet sáº½ tá»± Ä‘á»™ng start Pod kube-vip ngay láº­p tá»©c. LÃºc nÃ y báº¡n má»›i cháº¡y kubeadm init.

```bash
sudo kubeadm init --control-plane-endpoint "$VIP:6443" --upload-certs
```

Luá»“ng hoáº¡t Ä‘á»™ng: Kube-vip cháº¡y -> Chiáº¿m VIP -> kubeadm init káº¿t ná»‘i tá»›i $VIP:6443 (thá»±c cháº¥t lÃ  chÃ­nh node hiá»‡n táº¡i) -> Khá»Ÿi táº¡o thÃ nh cÃ´ng .

4. Má»Ÿ rá»™ng ra cÃ¡c Control Plane cÃ²n láº¡i

Sau khi node Ä‘áº§u tiÃªn cháº¡y xong:

1. TrÃªn node control plane Ä‘áº§u tiÃªn: Copy file manifest vá»«a táº¡o ra node khÃ¡c:
   scp /etc/kubernetes/manifests/kube-vip.yaml user@node2:/etc/kubernetes/manifests/
2. TrÃªn node thá»© 2, thá»© 3: Cháº¡y lá»‡nh kubeadm join vá»›i tham sá»‘ --control-plane do kubeadm init cung cáº¥p.
3. LÃºc nÃ y, kube-vip trÃªn cÃ¡c node cÃ²n láº¡i cÅ©ng sáº½ cháº¡y vÃ  tham gia Leader Election Ä‘á»ƒ giÃ nh quyá»n giá»¯ VIP .

5. CÃ¡c lÆ°u Ã½ ká»¹ thuáº­t quan trá»ng

Â· Váº¥n Ä‘á» vá»›i Kubernetes 1.29+: á» phiÃªn báº£n má»›i, admin.conf chÆ°a kháº£ dá»¥ng ngay láº­p tá»©c khi bootstrap. Báº¡n nÃªn dÃ¹ng super-admin.conf Ä‘á»ƒ cháº¡y kubeadm init hoáº·c cáº¥u hÃ¬nh cÃ¡c lá»‡nh copy file kubeconfig thá»§ cÃ´ng .
Â· RBAC cho cháº¿ Ä‘á»™ DaemonSet (K3s hoáº·c cluster Ä‘Ã£ cÃ³ sáºµn): Náº¿u báº¡n khÃ´ng dÃ¹ng Static Pod mÃ  cÃ i sau khi cluster Ä‘Ã£ cháº¡y (dáº¡ng add-on), hÃ£y Ã¡p dá»¥ng RBAC trÆ°á»›c:
  kubectl apply -f https://kube-vip.io/manifests/rbac.yaml .
Â· Capabilities: Container kube-vip yÃªu cáº§u cÃ¡c capability NET_ADMIN, NET_RAW. Báº¡n cÃ³ thá»ƒ tháº¥y Ä‘iá»u nÃ y rÃµ trong pháº§n securityContext cá»§a manifest .

6. XÃ¡c minh

Â· Kiá»ƒm tra Pod: kubectl get pods -n kube-system | grep kube-vip
Â· Kiá»ƒm tra VIP Ä‘Ã£ Ä‘Æ°á»£c bind trÃªn interface chÆ°a: ip a show $INTERFACE
Â· Truy cáº­p thá»­ API qua VIP: curl -k https://$VIP:6443/livez?verbose

TÃ³m láº¡i, cá»‘t lÃµi cá»§a viá»‡c cÃ i Ä‘áº·t lÃ  sinh manifest vÃ  Ä‘áº·t vÃ o Ä‘Ãºng thÆ° má»¥c static pod trÆ°á»›c kubeadm init. Náº¿u báº¡n gáº·p lá»—i cá»¥ thá»ƒ (vÃ­ dá»¥: VIP khÃ´ng ping Ä‘Æ°á»£c, leader election tháº¥t báº¡i), hÃ£y cung cáº¥p thÃªm thÃ´ng tin Ä‘á»ƒ mÃ¬nh há»— trá»£ chi tiáº¿t hÆ¡n.